{{#extend "stylesheets"}}
{{/extend}}

<!-- <div class="container">
	<div class="row">
		<div class="four columns">
			<div id="left">
				<p>hello</p>
			</div>
		</div>
		<div class="eight columns">
			<div id="map"></div>
		</div>
	</div>
</div> -->
<div id="left">
	<h4 id="header">Popular Lists Near You</h4>
	<hr>
	<h5><b>La Jolla Day Trip</b></h5>
	<p id="desc"><b>Destinations</b><br>Select* the places you want to visit & click submit to see the suggested path starting from your current location.<br><span id="instr">*Ctrl+Click or Cmd+Click for multiple selection</span></p>
	<select multiple id="waypoints">
    <option value="7702 Fay Ave, La Jolla, CA 92037">The Cottage</option>
    <option value="8300 Camino Del Oro, La Jolla, CA 92037">La Jolla Shores</option>
    <option value="1100 Coast Blvd, La Jolla, San Diego, CA 92037">La Jolla Cove</option>
    <option value="3750 Sports Arena Blvd, San Diego, CA 92110">Phil's BBQ</option>
  </select>
  <br>
  <input type="submit" id="submit">
  <div id="directions-panel"></div>
</div>
<div id="map"></div>

{{#extend "scripts"}}
<script>
var map, infoWindow, currPos, currPosMarker;
function initMap() {
	var directionsService = new google.maps.DirectionsService;
  var directionsDisplay = new google.maps.DirectionsRenderer;
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 32.8801, lng: -117.2340},
    zoom: 13
  });
  infoWindow = new google.maps.InfoWindow;

  // Try HTML5 geolocation.
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      // infoWindow.setPosition(pos);
      // infoWindow.setContent('Location found.');
      // infoWindow.open(map);
      map.setCenter(pos);
      currPos = pos;

      currPosMarker = new google.maps.Marker({
		    position: currPos,
		    map: map,
		    title: 'You are here.',
		    animation: google.maps.Animation.DROP,
        visible: true
		  });

		  infoWindow.setContent('You are here.');
		  infoWindow.open(map, currPosMarker);

		  currPosMarker.addListener('click', function() {
		  	if (currPosMarker.open) {
		  		infoWindow.open(map, currPosMarker);
		  		currPosMarker.open = false;
		  	} else {
		  		infoWindow.close();
		  		currPosMarker.open = true;
		  	}
      });
    }, function() {
      handleLocationError(true, infoWindow, map.getCenter());
    });
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false, infoWindow, map.getCenter());
  }

  directionsDisplay.setMap(map);
  directionsDisplay.setPanel(document.getElementById('directions-panel'));

  document.getElementById('submit').addEventListener('click', function() {
    // hide current location's marker
    currPosMarker.setVisible(false);
    infoWindow.close();
    currPosMarker.open = true;

  	calculateAndDisplayRoute(directionsService, directionsDisplay, currPos);
  });
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
  infoWindow.open(map);
}

function calculateAndDisplayRoute(directionsService, directionsDisplay, pos) {
  var waypts = [];
  var checkboxArray = document.getElementById('waypoints');
  for (var i = 0; i < checkboxArray.length-1; i++) {
    if (checkboxArray.options[i].selected) {
      waypts.push({
        location: checkboxArray[i].value,
        stopover: true
      });
    }
  }
	//Mohsin's addition start
	for (var j = checkboxArray.length-1) {
    if (checkboxArray.options[j].selected) {
      waypts.push({
        location: checkboxArray[j].value,
        stopover: false
      });
    }
  }
	//Mohsin's addition end

  directionsService.route({
    origin: currPos,
    destination: waypts.slice(-1)[0].location,
    waypoints: waypts,
    optimizeWaypoints: true,
    travelMode: 'DRIVING'
  }, function(response, status) {
    if (status === 'OK') {
      directionsDisplay.setDirections(response);
      /*var route = response.routes[0];
      var summaryPanel = document.getElementById('directions-panel');
      summaryPanel.innerHTML = '';
      // For each route, display summary information.
      for (var i = 0; i < route.legs.length; i++) {
        var routeSegment = i + 1;
        if (route.legs[i].start_address == route.legs[i].end_address) {
        	break;
        }
        summaryPanel.innerHTML += '<b>Route Segment: ' + routeSegment +
            '</b><br>';
        summaryPanel.innerHTML += route.legs[i].start_address + ' to ';
        summaryPanel.innerHTML += route.legs[i].end_address + '<br>';
        summaryPanel.innerHTML += route.legs[i].distance.text + '<br><br>';
      }*/
    } else {
      window.alert('Directions request failed due to ' + status);
    }
  });
}
</script>
<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD7l3pxQ6dq-Kgg-aVUO6-A0zf2swG2Cec&callback=initMap">
</script>
{{/extend}}
